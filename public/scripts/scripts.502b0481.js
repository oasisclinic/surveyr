"use strict";angular.module("frontendMark2App",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap","ui.bootstrap.tpls","ui.bootstrap.modal","ui.router","ngTable","api","auth","http-auth-interceptor","angular-loading-bar","highcharts-ng"]).config(["$stateProvider",function(a){a.state("home",{url:"/",templateUrl:"/views/home.html",controller:"HomeCtrl"}),a.state("entry",{url:"",templateUrl:"/views/home.html",controller:"HomeCtrl"}),a.state("patients",{url:"/patients/{patientId}",template:"<div ui-view></div>",controller:["$scope","$stateParams","$state","patients",function(a,b,c,d){d.get({patientId:b.patientId}).$promise.then(function(b){a.patient=b})}]}),a.state("patients.profile",{url:"/profile",templateUrl:"views/profile.html",controller:"ProfileCtrl"}),a.state("patients.chart",{url:"/chart/{surveyId}",templateUrl:"views/chart.html",controller:"ChartCtrl"}),a.state("patients.response",{url:"/response/{evaluationId}",templateUrl:"views/response.html",controller:"ResponseCtrl"}),a.state("search",{url:"/search",templateUrl:"views/search.html",controller:"SearchCtrl"}),a.state("survey",{url:"/surveys",template:"<div ui-view></div>"}),a.state("survey.give",{url:"/give",templateUrl:"views/pick-survey.html",controller:"GiveSurveyCtrl"}),a.state("survey.to",{url:"/give/{surveyId}/to",templateUrl:"views/to-survey.html",controller:"ToSurveyCtrl"}),a.state("survey.ready",{url:"/give/{surveyId}/to{patientId}",templateUrl:"views/ready-survey.html",controller:"SurveyReadyCtrl"}),a.state("survey.take",{url:"/take",templateUrl:"views/take-survey.html",controller:"TakeSurveyCtrl"}),a.state("complete",{url:"/complete/{requestId}/{responseId}",templateUrl:"views/complete-survey.html",controller:"CompleteCtrl"}),a.state("add",{url:"/add",templateUrl:"views/add.html",controller:"AddPatientCtrl"})}]).config(["cfpLoadingBarProvider",function(a){a.includeSpinner=!1}]).run(["$rootScope","$modal","authService",function(a,b){a.domain="http://localhost:9000/api",a.$on("event:auth-loginRequired",function(){a.loginModal||(a.loginModal=b.open({templateUrl:"views/modals/login.html",backdrop:"static",keyboard:!1,controller:"LoginCtrl"}))}),a.$on("event:auth-loginConfirmed",function(){a.loginModal.close()}),a.$on("event:api-error",function(c,d){a.apiModal||(a.apiModal=b.open(d))}),a.$on("event:api-error-dismiss",function(){a.apiModal.close()})}]),angular.module("api",["ngResource"]).factory("patients",["$resource","$rootScope",function(a,b){return a(b.domain+"/patients",null,{get:{url:b.domain+"/patients/:patientId",method:"GET",params:{patientId:"@patientId"}},createPatient:{url:b.domain+"/patients/create",method:"POST"},all:{method:"GET",isArray:!0}})}]).factory("evaluations",["$resource","$rootScope",function(a,b){return a(b.domain+"/evaluations/",null,{byPatientId:{method:"GET",url:b.domain+"/evaluations/results/:patientId",params:{patientId:"@patientId"},isArray:!0},bySurveyId:{method:"GET",url:b.domain+"/evaluations/results/:patientId/:surveyId",params:{surveyId:"@surveyId",patientId:"@patientId"}},byId:{method:"GET",url:b.domain+"/evaluations/:evaluationId",params:{surveyId:"@evaluationId"}},remove:{method:"DELETE",url:b.domain+"/evaluations/:evaluationId",params:{surveyId:"@evaluationId"}},make:{method:"GET",url:b.domain+"/evaluations/start/:patientId/:surveyId",params:{surveyId:"@surveyId",patientId:"@patientId"}},recent:{method:"GET",url:b.domain+"/evaluations?limit=:limit",params:{limit:"@limit"},isArray:!0},complete:{method:"GET",url:b.domain+"/evaluations/complete/:requestId/:responseId",params:{requestId:"@requestId",responseId:"@responseId"}}})}]).factory("surveys",["$resource","$rootScope",function(a,b){return a(b.domain+"/surveys/",null,{get:{method:"GET",isArray:!0}})}]),angular.module("auth",[]).factory("securityService",["$http","$rootScope","Session",function(a,b,c){var d={};return d.login=function(d){return a.post(b.domain+"/authenticate",d).then(function(a){c.create(a.data.token)})},d.isAuthenticated=function(){return!!c.userId},d}]).service("Session",function(){return this.create=function(a){this.id=a},this.destroy=function(){this.id=null},this}).config(["$httpProvider",function(a){a.interceptors.push(["$injector",function(a){return a.get("AuthInterceptor")}])}]).factory("AuthInterceptor",["$rootScope","$q","Session",function(a,b,c){return{request:function(a){return c.id&&(a.headers["x-auth-token"]=c.id),a}}}]).controller("LoginCtrl",["$scope","$rootScope","authService","securityService","Session",function(a,b,c,d,e){a.credentials={username:"",password:""},a.login=function(a){d.login(a).then(function(){var a=function(a){return a.headers["x-auth-token"]=e.id,a};c.loginConfirmed(null,a)},function(){c.loginCancelled()})}}]),function(){angular.module("http-auth-interceptor",["http-auth-interceptor-buffer"]).factory("authService",["$rootScope","httpBuffer",function(a,b){return{loginConfirmed:function(c,d){var e=d||function(a){return a};a.$broadcast("event:auth-loginConfirmed",c),b.retryAll(e)},loginCancelled:function(c,d){b.rejectAll(d),a.$broadcast("event:auth-loginCancelled",c)}}}]).config(["$httpProvider",function(a){a.interceptors.push(["$rootScope","$q","httpBuffer",function(a,b,c){return{responseError:function(d){if(!d.config.ignoreAuthModule)switch(d.status){case 401:var e=b.defer();return c.append(d.config,e),a.$broadcast("event:auth-loginRequired",d),e.promise;case 403:a.$broadcast("event:auth-forbidden",d);break;default:var f={templateUrl:"views/modals/generic-modal.html",resolve:{message:function(){return d.data?d.data.message:"We could not get in touch with the server. Please check your internet connection or contact an administrator."},title:function(){return"Oh No!"}},controller:function(b,c,d){b.message=c,b.title=d,b.close=function(){a.$broadcast("event:api-error-dismiss",null)}}};a.$broadcast("event:api-error",f)}return b.reject(d)}}}])}]),angular.module("http-auth-interceptor-buffer",[]).factory("httpBuffer",["$injector",function(a){function b(b,d){function e(a){d.resolve(a)}function f(a){d.reject(a)}c=c||a.get("$http"),c(b).then(e,f)}var c,d=[];return{append:function(a,b){d.push({config:a,deferred:b})},rejectAll:function(a){if(a)for(var b=0;b<d.length;++b)d[b].deferred.reject(a);d=[]},retryAll:function(a){for(var c=0;c<d.length;++c)b(a(d[c].config),d[c].deferred);d=[]}}}])}(),angular.module("frontendMark2App").controller("AddPatientCtrl",["$scope","$modal","$state","patients",function(a,b,c,d){a.patient=null,a.submit=function(a){d.createPatient({},a).$promise.then(function(a){var d=b.open({templateUrl:"views/modals/generic-modal.html",resolve:{message:function(){return"Patient "+a.firstName+" "+a.lastName+" was successfully created."},title:function(){return"Success!"}},controller:["$scope","message","title",function(a,b,c){a.message=b,a.title=c}]});d.result.then(null,function(){c.go("home",{})})})}}]),angular.module("frontendMark2App").controller("GiveSurveyCtrl",["$scope","$filter","$state","surveys","ngTableParams",function(a,b,c,d,e){d.get().$promise.then(function(c){a.tableParams=new e({page:1,count:10},{total:0,getData:function(d,e){var f=e.filter()?b("filter")(c,e.filter()):a.data,g=e.sorting()?b("orderBy")(f,e.orderBy()):a.data;e.total(g.length),d.resolve(g.slice((e.page()-1)*e.count(),e.page()*e.count()))}}),a.data=c}),a.changeSelection=function(a){c.go("survey.to",{surveyId:a.id})}}]).controller("ToSurveyCtrl",["$scope","$filter","$state","$stateParams","patients","ngTableParams",function(a,b,c,d,e,f){e.all().$promise.then(function(c){a.tableParams=new f({page:1,count:10},{total:0,getData:function(d,e){var f=e.filter()?b("filter")(c,e.filter()):a.data,g=e.sorting()?b("orderBy")(f,e.orderBy()):a.data;e.total(g.length),d.resolve(g.slice((e.page()-1)*e.count(),e.page()*e.count()))}}),a.data=c}),a.changeSelection=function(a){c.go("survey.ready",{surveyId:d.surveyId,patientId:a.patientId})}}]).controller("SurveyReadyCtrl",["$stateParams","$scope","evaluations",function(a,b,c){b.pin=c.make({patientId:a.patientId,surveyId:a.surveyId})}]).controller("TakeSurveyCtrl",["$scope","$rootScope","$http","$window",function(a,b,c,d){a.pin=function(a){c.get(b.domain+"/evaluations/start/"+a).success(function(a){d.location.href=a.url})}}]).controller("CompleteCtrl",["$scope","$stateParams","evaluations",function(a,b,c){c.complete({requestId:b.requestId,responseId:b.responseId}).$promise.then(function(b){a.evaluation=b})}]),angular.module("frontendMark2App").controller("ProfileCtrl",["$scope","$stateParams","$filter","patients","evaluations","ngTableParams",function(a,b,c,d,e,f){e.byPatientId({patientId:b.patientId}).$promise.then(function(b){a.tableParams=new f({page:1,count:10},{total:0,getData:function(b,d){var e=d.filter()?c("filter")(a.data,d.filter()):a.data,f=d.sorting()?c("orderBy")(e,d.orderBy()):a.data;d.total(f.length),b.resolve(f.slice((d.page()-1)*d.count(),d.page()*d.count()))}}),a.data=b}),a.remove=function(b){e.remove({evaluationId:b}).$promise.then(function(){for(var c=0;c<a.data.length;c++)if(a.data[c].evaluationId===b){a.data.splice(c,1);break}a.tableParams.reload()})}}]),angular.module("frontendMark2App").controller("SearchCtrl",["$scope","$filter","$resource","$state","patients","ngTableParams",function(a,b,c,d,e,f){e.all().$promise.then(function(c){a.tableParams=new f({page:1,count:10},{total:0,getData:function(d,e){var f=e.filter()?b("filter")(c,e.filter()):a.data,g=e.sorting()?b("orderBy")(f,e.orderBy()):a.data;e.total(g.length),d.resolve(g.slice((e.page()-1)*e.count(),e.page()*e.count()))}}),a.data=c}),a.changeSelection=function(a){d.go("patients.profile",{patientId:a.patientId})}}]),angular.module("frontendMark2App").controller("ChartCtrl",["$scope","$stateParams","$filter","evaluations",function(a,b,c,d){function e(a){var b=[];for(var c in a.definition)b[c]={name:a.definition[c],data:[]},a.data.forEach(function(a){b[c].data.push([a.date,a.data[c]])});return b}d.bySurveyId({patientId:b.patientId,surveyId:b.surveyId}).$promise.then(function(b){var c=e(b);for(var d in c)a.addSeries(c[d]);a.toggleLoading()}),a.addSeries=function(b){a.chartConfig.series||(a.chartConfig.series=[]),a.chartConfig.series.push(b)},a.removeSeries=function(b){var c=a.chartConfig.series;c.splice(b,1)},a.toggleLoading=function(){this.chartConfig.loading=!this.chartConfig.loading},a.chartConfig={options:{chart:{type:"spline",zoomType:"x"}},series:null,title:{text:a.patient.firstName+" "+a.patient.lastName},xAxis:{dateTimeLabelFormats:{millisecond:"%m/%d/%y %H:%M",second:"%m/%d/%y %H:%M",minute:"%m/%d/%y %H:%M",hour:"%m/%d/%y %H:%M",day:"%m/%d/%y",week:"%m/%Y",month:"%m/%Y",year:"%Y"},type:"datetime"},loading:!0}}]),angular.module("frontendMark2App").controller("ResponseCtrl",["$scope","$stateParams","evaluations",function(a,b,c){a.evaluation=c.byId({evaluationId:b.evaluationId})}]),angular.module("frontendMark2App").controller("HomeCtrl",["$scope","$stateParams","$filter","evaluations","ngTableParams",function(a,b,c,d,e){d.recent({limit:20}).$promise.then(function(b){a.tableParams=new e({page:1,count:10},{total:0,getData:function(b,d){var e=d.filter()?c("filter")(a.data,d.filter()):a.data,f=d.sorting()?c("orderBy")(e,d.orderBy()):a.data;d.total(f.length),b.resolve(f.slice((d.page()-1)*d.count(),d.page()*d.count()))}}),a.data=b})}]);